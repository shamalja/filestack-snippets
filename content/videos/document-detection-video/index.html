<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document Detection & OCR Demo</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #fff5f0 0%, #ffffff 100%);
      color: #334155;
      line-height: 1.6;
      padding: 2rem;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 0.5rem;
      color: #FF5C35;
    }

    .subtitle {
      text-align: center;
      color: #64748b;
      margin-bottom: 3rem;
      font-size: 1.1rem;
    }

    .upload-area {
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      padding: 3rem;
      text-align: center;
      background: white;
      transition: border-color 0.2s, background 0.2s;
      cursor: pointer;
    }

    .upload-area:hover,
    .upload-area.dragover {
      border-color: #FF5C35;
      background: #fff5f0;
    }

    .upload-area input {
      display: none;
    }

    .upload-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 1rem;
      color: #94a3b8;
    }

    .upload-btn {
      display: inline-block;
      padding: 0.75rem 2rem;
      background: #FF5C35;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 1rem;
      transition: background 0.2s, transform 0.1s;
    }

    .upload-btn:hover {
      background: #e54d2b;
      transform: translateY(-1px);
    }

    .hint {
      font-size: 0.813rem;
      color: #94a3b8;
      margin-top: 1rem;
    }

    .main-content {
      display: none;
    }

    .main-content.visible {
      display: block;
    }

    .top-section {
      display: flex;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .image-card {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.07);
      flex: 1;
    }

    .image-card h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #1e293b;
    }

    .image-card h3 .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .image-card h3 .dot.orange { background: #FF5C35; }
    .image-card h3 .dot.blue { background: #3b82f6; }
    .image-card h3 .dot.green { background: #22c55e; }
    .image-card h3 .dot.purple { background: #8b5cf6; }

    .image-wrapper {
      aspect-ratio: 4/3;
      background: #f1f5f9;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .image-wrapper img,
    .image-wrapper canvas {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #fee2d5;
      border-top-color: #FF5C35;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 0.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .actions {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .btn {
      padding: 0.875rem 2rem;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #FF5C35;
      color: white;
    }

    .btn-primary:hover {
      background: #e54d2b;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 92, 53, 0.3);
    }

    .btn-primary:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: white;
      color: #64748b;
      border: 2px solid #e2e8f0;
    }

    .btn-secondary:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
      transform: translateY(-1px);
    }

    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .result-card {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }

    .result-card h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #1e293b;
    }

    .result-card .description {
      font-size: 0.875rem;
      color: #64748b;
      margin-bottom: 1rem;
    }

    .result-card .image-wrapper {
      margin-bottom: 1rem;
    }

    .code-block {
      background: #1e293b;
      border-radius: 12px;
      padding: 1.25rem;
      margin-top: 1rem;
    }

    .code-block p {
      color: #94a3b8;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .code-block code {
      color: #60a5fa;
      font-size: 0.95rem;
      word-break: break-all;
      display: block;
      line-height: 1.7;
      font-family: 'Monaco', 'Courier New', monospace;
      max-height: 180px;
      overflow-y: auto;
    }

    .code-block code .param-highlight {
      background: #FF5C35;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }

    .code-block code .ocr-highlight {
      background: #22c55e;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }

    .code-block code .masked {
      color: #64748b;
    }

    .ocr-section {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.07);
      border-left: 4px solid #FF5C35;
    }

    .ocr-section h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }

    .ocr-section .description {
      font-size: 0.875rem;
      color: #64748b;
      margin-bottom: 1.5rem;
    }

    .ocr-text {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 1.5rem;
      font-size: 1.05rem;
      line-height: 1.8;
      color: #334155;
      white-space: pre-wrap;
      margin-bottom: 1rem;
    }

    .ocr-json {
      background: #1e293b;
      border-radius: 12px;
      padding: 1.25rem;
    }

    .ocr-json p {
      color: #94a3b8;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .ocr-json code {
      color: #4ade80;
      font-size: 0.9rem;
      display: block;
      line-height: 1.6;
      font-family: 'Monaco', 'Courier New', monospace;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .loading-overlay {
      display: none;
      text-align: center;
      padding: 3rem;
    }

    .loading-overlay.visible {
      display: block;
    }

    .error {
      background: #fef3c7;
      border: 2px solid #fcd34d;
      color: #92400e;
      padding: 1.25rem;
      border-radius: 12px;
      margin-top: 1.5rem;
      font-size: 1rem;
      display: none;
      font-weight: 500;
    }

    .error.visible {
      display: block;
    }

    .hidden {
      display: none !important;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #94a3b8;
      font-size: 0.875rem;
    }

    .step.active {
      color: #FF5C35;
      font-weight: 600;
    }

    .step.completed {
      color: #22c55e;
    }

    .step-number {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .step.active .step-number {
      background: #FF5C35;
      color: white;
    }

    .step.completed .step-number {
      background: #22c55e;
      color: white;
    }

    .step-divider {
      width: 40px;
      height: 2px;
      background: #e2e8f0;
    }

    .bbox-legend {
      display: flex;
      gap: 1rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }

    .bbox-legend-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.75rem;
      color: #64748b;
    }

    .bbox-legend-color {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      border: 2px solid;
    }

    @media (max-width: 768px) {
      .top-section,
      .results-grid {
        grid-template-columns: 1fr;
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Document Detection & OCR Demo</h1>
    <p class="subtitle">Upload a document photo to see how Filestack straightens, preprocesses, and extracts text.</p>

    <div class="upload-area" id="uploadArea">
      <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
      </svg>
      <p>Drag and drop a document image here</p>
      <button class="upload-btn">Choose Image</button>
      <p class="hint">Try a receipt, ID, or any document photo</p>
    </div>

    <div class="main-content" id="mainContent">
      <div class="step-indicator">
        <div class="step" id="step1">
          <span class="step-number">1</span>
          <span>Upload</span>
        </div>
        <div class="step-divider"></div>
        <div class="step" id="step2">
          <span class="step-number">2</span>
          <span>Process</span>
        </div>
        <div class="step-divider"></div>
        <div class="step" id="step3">
          <span class="step-number">3</span>
          <span>Extract Text</span>
        </div>
      </div>

      <div class="top-section">
        <div class="image-card">
          <h3><span class="dot orange"></span> Original Upload</h3>
          <div class="image-wrapper">
            <img id="originalImage" src="" alt="Original">
          </div>
        </div>
      </div>

      <div class="actions" id="actions">
        <button class="btn btn-primary" id="processBtn">Process Document</button>
        <button class="btn btn-secondary" id="resetBtn">Start Over</button>
      </div>

      <div class="loading-overlay" id="loadingIndicator">
        <div class="spinner"></div>
        <p>Processing document...</p>
      </div>

      <div class="results-grid hidden" id="resultsGrid">
        <div class="result-card">
          <h3><span class="dot blue"></span> Warped Mode</h3>
          <p class="description">Document straightened, original colors preserved</p>
          <div class="image-wrapper">
            <img id="warpedImage" src="" alt="Warped">
          </div>
          <div class="code-block">
            <p>API URL:</p>
            <code id="warpedUrl"></code>
          </div>
        </div>

        <div class="result-card">
          <h3><span class="dot green"></span> Preprocessed Image</h3>
          <p class="description">Straightened + denoised + contrast enhanced</p>
          <div class="image-wrapper">
            <img id="preprocessedImage" src="" alt="Preprocessed">
          </div>
          <div class="code-block">
            <p>API URL:</p>
            <code id="preprocessedUrl"></code>
          </div>
        </div>

        <div class="result-card">
          <h3><span class="dot purple"></span> OCR Bounding Boxes</h3>
          <p class="description">Detected text areas highlighted on the image</p>
          <div class="image-wrapper">
            <canvas id="bboxCanvas"></canvas>
          </div>
          <div class="bbox-legend">
            <div class="bbox-legend-item">
              <span class="bbox-legend-color" style="border-color: #FF5C35; background: rgba(255,92,53,0.1);"></span>
              <span>Text Areas</span>
            </div>
            <div class="bbox-legend-item">
              <span class="bbox-legend-color" style="border-color: #3b82f6; background: rgba(59,130,246,0.1);"></span>
              <span>Lines</span>
            </div>
            <div class="bbox-legend-item">
              <span class="bbox-legend-color" style="border-color: #22c55e; background: rgba(34,197,94,0.1);"></span>
              <span>Words</span>
            </div>
          </div>
          <div class="code-block">
            <p>API URL:</p>
            <code id="ocrUrl"></code>
          </div>
        </div>
      </div>

      <div class="ocr-section hidden" id="ocrSection">
        <h3>Extracted Text (OCR)</h3>
        <p class="description">Text extracted from the preprocessed image</p>
        <div class="ocr-text" id="ocrText"></div>
        <div class="ocr-json">
          <p>Full API Response:</p>
          <code id="ocrResponse"></code>
        </div>
      </div>
    </div>

    <div class="error" id="errorMessage"></div>
  </div>

  <script src="//static.filestackapi.com/filestack-js/4.x.x/filestack.min.js"></script>
  <script>
    // Configuration
    const API_KEY = '1';
    const POLICY = '2';
    const SIGNATURE = '3';

    const MASKED_SECURITY = 'security=p:••••••••••••,s:••••••••••••';

    const client = filestack.init(API_KEY, {
      security: {
        policy: POLICY,
        signature: SIGNATURE
      }
    });

    // DOM elements
    const uploadArea = document.getElementById('uploadArea');
    const mainContent = document.getElementById('mainContent');
    const originalImage = document.getElementById('originalImage');
    const warpedImage = document.getElementById('warpedImage');
    const preprocessedImage = document.getElementById('preprocessedImage');
    const bboxCanvas = document.getElementById('bboxCanvas');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const processBtn = document.getElementById('processBtn');
    const resetBtn = document.getElementById('resetBtn');
    const resultsGrid = document.getElementById('resultsGrid');
    const ocrSection = document.getElementById('ocrSection');
    const warpedUrl = document.getElementById('warpedUrl');
    const preprocessedUrl = document.getElementById('preprocessedUrl');
    const ocrText = document.getElementById('ocrText');
    const ocrResponse = document.getElementById('ocrResponse');
    const ocrUrl = document.getElementById('ocrUrl');
    const errorMessage = document.getElementById('errorMessage');
    const actions = document.getElementById('actions');

    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');

    let currentHandle = null;

    // Function to create display URL with highlights
    function createDisplayUrl(type, handle) {
      const base = 'https://cdn.filestackcontent.com/';
      
      if (type === 'warped') {
        return `${base}<span class="masked">${MASKED_SECURITY}</span>/<span class="param-highlight">doc_detection=preprocess:false</span>/${handle}`;
      } else if (type === 'preprocessed') {
        return `${base}<span class="masked">${MASKED_SECURITY}</span>/<span class="param-highlight">doc_detection=preprocess:true</span>/${handle}`;
      } else if (type === 'ocr') {
        return `${base}<span class="masked">${MASKED_SECURITY}</span>/<span class="param-highlight">doc_detection=preprocess:true</span>/<span class="ocr-highlight">ocr</span>/${handle}`;
      }
    }

    // Draw bounding boxes on canvas
    function drawBoundingBoxes(img, ocrData) {
      const canvas = bboxCanvas;
      const ctx = canvas.getContext('2d');
      
      // Set canvas size to match image
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      
      // Draw the image first
      ctx.drawImage(img, 0, 0);
      
      // Get scale factors if the OCR response has different dimensions
      const scaleX = img.naturalWidth / (ocrData.page_width || img.naturalWidth);
      const scaleY = img.naturalHeight / (ocrData.page_height || img.naturalHeight);
      
      // Draw text areas (orange)
      if (ocrData.document && ocrData.document.text_areas) {
        ocrData.document.text_areas.forEach(area => {
          if (area.bounding_box && area.bounding_box.length >= 4) {
            drawPolygon(ctx, area.bounding_box, scaleX, scaleY, '#FF5C35', 3);
          }
          
          // Draw lines within each text area (blue)
          if (area.lines) {
            area.lines.forEach(line => {
              if (line.bounding_box && line.bounding_box.length >= 4) {
                drawPolygon(ctx, line.bounding_box, scaleX, scaleY, '#3b82f6', 2);
              }
              
              // Draw words within each line (green)
              if (line.words) {
                line.words.forEach(word => {
                  if (word.bounding_box && word.bounding_box.length >= 4) {
                    drawPolygon(ctx, word.bounding_box, scaleX, scaleY, '#22c55e', 1);
                  }
                });
              }
            });
          }
        });
      }
    }

    // Draw a polygon from bounding box points
    function drawPolygon(ctx, points, scaleX, scaleY, color, lineWidth) {
      if (points.length < 4) return;
      
      ctx.beginPath();
      ctx.strokeStyle = color;
      ctx.lineWidth = lineWidth;
      
      // Move to first point
      ctx.moveTo(points[0].x * scaleX, points[0].y * scaleY);
      
      // Draw lines to remaining points
      for (let i = 1; i < points.length; i++) {
        ctx.lineTo(points[i].x * scaleX, points[i].y * scaleY);
      }
      
      // Close the path
      ctx.closePath();
      ctx.stroke();
      
      // Add semi-transparent fill
      ctx.fillStyle = color.replace(')', ', 0.08)').replace('rgb', 'rgba').replace('#', '');
      // Convert hex to rgba for fill
      const r = parseInt(color.slice(1, 3), 16);
      const g = parseInt(color.slice(3, 5), 16);
      const b = parseInt(color.slice(5, 7), 16);
      ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.08)`;
      ctx.fill();
    }

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });

    // Click anywhere on upload area to open Filestack picker
    uploadArea.addEventListener('click', () => {
      const pickerOptions = {
        accept: ['image/*'],
        maxFiles: 1,
        uploadInBackground: false,
        onUploadDone: (res) => {
          if (res.filesUploaded && res.filesUploaded.length > 0) {
            const file = res.filesUploaded[0];
            currentHandle = file.handle;
            
            // Build the secure URL for the original image
            const originalUrl = `https://cdn.filestackcontent.com/security=p:${POLICY},s:${SIGNATURE}/${file.handle}`;
            originalImage.src = originalUrl;
            
            // Show main content
            uploadArea.style.display = 'none';
            mainContent.classList.add('visible');
            resultsGrid.classList.add('hidden');
            ocrSection.classList.add('hidden');
            processBtn.disabled = false;
            updateSteps(1);
            step1.classList.remove('active');
            step1.classList.add('completed');
          }
        }
      };
      
      client.picker(pickerOptions).open();
    });

    function updateSteps(current) {
      [step1, step2, step3].forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < current) {
          step.classList.add('completed');
        } else if (index + 1 === current) {
          step.classList.add('active');
        }
      });
    }

    async function handleFile(file) {
      if (!file.type.startsWith('image/')) {
        showError('Please upload an image file');
        return;
      }

      hideError();
      
      const reader = new FileReader();
      reader.onload = (e) => {
        originalImage.src = e.target.result;
      };
      reader.readAsDataURL(file);

      uploadArea.style.display = 'none';
      mainContent.classList.add('visible');
      resultsGrid.classList.add('hidden');
      ocrSection.classList.add('hidden');
      processBtn.disabled = true;
      updateSteps(1);

      try {
        const result = await client.upload(file);
        currentHandle = result.handle;
        processBtn.disabled = false;
        updateSteps(1);
        step1.classList.remove('active');
        step1.classList.add('completed');
      } catch (err) {
        showError('Upload failed: ' + err.message);
        processBtn.disabled = true;
      }
    }

    processBtn.addEventListener('click', async () => {
      if (!currentHandle) return;

      loadingIndicator.classList.add('visible');
      actions.classList.add('hidden');
      resultsGrid.classList.add('hidden');
      ocrSection.classList.add('hidden');
      processBtn.disabled = true;
      hideError();
      updateSteps(2);

      const baseUrl = `https://cdn.filestackcontent.com/security=p:${POLICY},s:${SIGNATURE}`;
      const warpedApiUrl = `${baseUrl}/doc_detection=preprocess:false/${currentHandle}`;
      const preprocessedApiUrl = `${baseUrl}/doc_detection=preprocess:true/${currentHandle}`;
      const ocrApiUrl = `${baseUrl}/doc_detection=preprocess:true/ocr/${currentHandle}`;

      try {
        // Load warped and preprocessed images
        warpedImage.src = warpedApiUrl;
        preprocessedImage.src = preprocessedApiUrl;
        warpedUrl.innerHTML = createDisplayUrl('warped', currentHandle);
        preprocessedUrl.innerHTML = createDisplayUrl('preprocessed', currentHandle);

        // Wait for both images to load
        await Promise.all([
          new Promise((resolve, reject) => {
            warpedImage.onload = resolve;
            warpedImage.onerror = reject;
          }),
          new Promise((resolve, reject) => {
            preprocessedImage.onload = resolve;
            preprocessedImage.onerror = reject;
          })
        ]);

        // Show results grid
        resultsGrid.classList.remove('hidden');
        updateSteps(3);

        // Fetch OCR results
        const ocrFetchResponse = await fetch(ocrApiUrl);
        
        if (!ocrFetchResponse.ok) {
          throw new Error(`OCR request failed: ${ocrFetchResponse.status}`);
        }

        const ocrData = await ocrFetchResponse.json();

        loadingIndicator.classList.remove('visible');
        actions.classList.remove('hidden');

        // Draw bounding boxes on canvas using the preprocessed image
        drawBoundingBoxes(preprocessedImage, ocrData);

        // Display OCR results
        if (ocrData && ocrData.text) {
          ocrText.textContent = ocrData.text;
          ocrResponse.textContent = JSON.stringify(ocrData, null, 2);
          ocrUrl.innerHTML = createDisplayUrl('ocr', currentHandle);
          ocrSection.classList.remove('hidden');
          step3.classList.remove('active');
          step3.classList.add('completed');
        } else {
          showError('No text was extracted from this image.');
        }

      } catch (err) {
        loadingIndicator.classList.remove('visible');
        actions.classList.remove('hidden');
        showError('Processing failed: ' + err.message);
        processBtn.disabled = false;
      }
    });

    resetBtn.addEventListener('click', () => {
      uploadArea.style.display = 'block';
      mainContent.classList.remove('visible');
      resultsGrid.classList.add('hidden');
      ocrSection.classList.add('hidden');
      actions.classList.remove('hidden');
      currentHandle = null;
      processBtn.disabled = false;
      hideError();
      updateSteps(0);
      
      // Clear canvas
      const ctx = bboxCanvas.getContext('2d');
      ctx.clearRect(0, 0, bboxCanvas.width, bboxCanvas.height);
    });

    function showError(msg) {
      errorMessage.textContent = msg;
      errorMessage.classList.add('visible');
    }

    function hideError() {
      errorMessage.classList.remove('visible');
    }
  </script>
</body>
</html>